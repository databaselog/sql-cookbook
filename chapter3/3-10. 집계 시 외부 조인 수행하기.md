## 3-10. 집계 시 외부 조인 수행하기

### 문제
- 3-9와 같은 문제: 집계 사용 + 조인 수행 시 중복 문제
- 부서 10 내 일부 사원에게만 보너스 부여 → `emp_bonus`테이블 수정

    |empno|received|type|
    |-----|--------|----|
    |7934|17-MAR-2005|1|
    |7934|15-FEB-2005|2|

- 발생하는 중복 문제 (`FROM` 절 서브쿼리)
```sqL
  select e.empno,
          e.ename,
          e.sal,
          e.deptno,
          e.sal*case when eb.type=1 then .1
                      when eb.type=2 then .2
                      else .3 end as bonus
    from emp e, emp_bonus eb
  where e.empno = eb.empno
    and e.deptno = 10
```
`total_sum`에서 오류 생김  
이유: `FROM` 절 서브쿼리에서 `WHERE` 조건에 일치하는 행, `emp_bonus` 테이블 내 miller(7934)의 급여만 중복합산 

- **목표 결과셋**: 전 직원에 대한 `total_sal`, miller에 대한 `total_bonus`

### 해법
부서 10의 모든 사원이 포함되도록 `emp_bonus`를 `OUTER JOIN`

#### DB2, MySQL, PostgreSQL, SQL Server
`emp_bonus`에 `OUTER JOIN`한 후, 부서 10의 급여 고유값(`DISTINCT`)에 대해서만 `SUM()`수행
`OUTER JOIN`으로 `emp_bonus`에 없는 부서원들도 출력
```sql
select deptno,
    sum(distinct sal) as total_sal, -- 수정: DISTINCT 사용
    sum(bonus) as total_bonus
  from (
    select e.empno,
          e.ename,
          e.sal,
          e.deptno,
          e.sal*case when eb.type is null then 0
                    when eb.type = 1 then .1
                    when eb.type = 2 then .2
                    else .3 end as bonus
          from emp e left outer join emp_bonus eb --수정: OUTER JOIN 사용
            on (e.empno = eb.empno)
          where e.deptno=10
  )
group by deptno 
